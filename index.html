<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Email Receiver</title>
<link rel="icon" href="icon.png" type="image/png">

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", sans-serif;
        background: #0d0b14;
        color: #e6dfff;
        overflow-x: hidden;
    }

    /* Aura t√≠m n·ªÅn */
    .aura {
        position: fixed;
        width: 600px;
        height: 600px;
        top: -150px;
        left: -150px;
        background: radial-gradient(circle, rgba(140, 0, 255, 0.4), transparent 70%);
        filter: blur(120px);
        z-index: 0;
        pointer-events: none;
    }

    h1 {
        text-align: center;
        margin-top: 40px;
        font-size: 38px;
        color: #c38aff;
        text-shadow: 0 0 20px #9100ff, 0 0 40px #7000e3;
    }

    .container {
        max-width: 900px;
        margin: auto;
        padding: 20px;
        margin-top: 30px;
        position: relative;
        z-index: 1;
    }

    .email-counter {
        font-size: 20px;
        margin-bottom: 20px;
        padding: 12px 18px;
        width: fit-content;
        border-radius: 12px;
        background: rgba(80, 0, 150, 0.25);
        box-shadow: 0 0 15px #5800c9;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(170, 0, 255, 0.3);
    }

    .email-card {
        background: rgba(30, 0, 60, 0.45);
        margin-bottom: 20px;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid rgba(160, 0, 255, 0.2);
        box-shadow: 0 0 15px rgba(100, 0, 150, 0.4);
        backdrop-filter: blur(8px);
        transition: 0.2s ease;
    }

    .email-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 25px rgba(150, 0, 255, 0.5);
    }

    .email-title {
        font-size: 18px;
        font-weight: bold;
    }

    .email-from {
        color: #d4b5ff;
        font-size: 14px;
        margin-top: 6px;
        opacity: 0.9;
    }

    .email-body {
        margin-top: 15px;
        font-size: 15px;
        line-height: 1.5;
        white-space: pre-wrap;
    }

    .note-box {
        margin-top: 40px;
        padding: 15px;
        border-left: 5px solid #a300ff;
        background: rgba(50, 0, 90, 0.35);
        border-radius: 8px;
        font-size: 15px;
        box-shadow: 0 0 12px rgba(150, 0, 255, 0.4);
    }
</style>
</head>

<body>

<div class="aura"></div>

<h1>üì® Email Receiver</h1>

<div class="container">
    <div id="emailCounter" class="email-counter">ƒêang t·∫£i...</div>
    <div id="emailList"></div>

    <div class="note-box">
        <b>L∆∞u √Ω:</b>  
        C√≥ th·ªÉ s·∫Ω ph·∫£i ƒë·ª£i kh√° l√¢u ƒë·ªÉ update Email v√¨ ph·∫£i ƒë·ª£i Email t·ªõi ‚Üí Google ph·∫£n h·ªìi ‚Üí GitHub l·∫•y d·ªØ li·ªáu  
        (kho·∫£ng h∆°n <b>2 ph√∫t</b>).
    </div>
</div>

<script>
  // URL raw c·ªßa file tr√™n branch "data"
  const RAW_JSON = "https://raw.githubusercontent.com/HAPPY-script/Email-receiver/data/emails.json";

  let lastText = null; // l∆∞u n·ªôi dung JSON d·∫°ng text l·∫ßn cu·ªëi (so s√°nh)
  let pollingInterval = 3000; // 3s, c√≥ th·ªÉ thay th√†nh 5000 ho·∫∑c 10000 n·∫øu mu·ªën gi·∫£m request

  // Render UI t·ª´ object JSON
  function renderEmails(data) {
    const counter = document.getElementById("emailCounter");
    const list = document.getElementById("emailList");

    // n·∫øu data kh√¥ng l√† m·∫£ng, x·ª≠ l√Ω an to√†n
    if (!Array.isArray(data)) {
      counter.innerText = "D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá.";
      list.innerHTML = "";
      return;
    }

    // n·∫øu r·ªóng, x√≥a list v√† th√¥ng b√°o r√µ r√†ng
    if (data.length === 0) {
      counter.innerText = "S·ªë l∆∞·ª£ng Email: 0";
      list.innerHTML = `<div class="email-card" style="opacity:0.9">Kh√¥ng c√≥ email n√†o.</div>`;
      return;
    }

    counter.innerText = "S·ªë l∆∞·ª£ng Email: " + data.length;
    list.innerHTML = "";

    // hi·ªÉn th·ªã email (m·ªõi nh·∫•t ·ªü tr√™n c√πng n·∫øu d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ƒë·∫£o tr∆∞·ªõc ƒë√≥)
    data.forEach(email => {
      const div = document.createElement("div");
      div.className = "email-card";
      // an to√†n: escape m·ªôt ch√∫t n·ªôi dung tr√°nh HTML injection
      const subj = (email.subject || "(Kh√¥ng ti√™u ƒë·ªÅ)").replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      const from = (email.from || "(Kh√¥ng c√≥)").replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      const body = (email.body || "").replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\n','<br>');
      div.innerHTML = `
        <div class="email-title">${subj}</div>
        <div class="email-from">üìß T·ª´: ${from}</div>
        <div class="email-body">${body}</div>
      `;
      list.appendChild(div);
    });
  }

  // Load v√† render ngay (full fetch)
  async function loadEmailsNow() {
    try {
      const res = await fetch(RAW_JSON + "?t=" + Date.now(), { cache: "no-store" });
      if (!res.ok) {
        console.warn("loadEmailsNow: fetch failed", res.status, res.statusText);
        document.getElementById("emailCounter").innerText = "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu Email.";
        return;
      }
      const text = await res.text();
      lastText = text; // c·∫≠p nh·∫≠t lastText
      let data = [];
      try { data = JSON.parse(text || "[]"); } catch(e) {
        console.error("JSON parse error:", e);
        document.getElementById("emailCounter").innerText = "D·ªØ li·ªáu JSON kh√¥ng h·ª£p l·ªá.";
        return;
      }

      renderEmails(data);
    } catch (err) {
      console.error("loadEmailsNow error:", err);
      document.getElementById("emailCounter").innerText = "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu Email.";
    }
  }

  // Ki·ªÉm tra thay ƒë·ªïi b·∫±ng c√°ch l·∫•y text v√† so s√°nh v·ªõi lastText
  async function checkUpdate() {
    try {
      // t·∫£i text m·ªõi (cache-bust b·∫±ng timestamp)
      const res = await fetch(RAW_JSON + "?t=" + Date.now(), { cache: "no-store" });
      if (!res.ok) {
        console.warn("checkUpdate: fetch failed", res.status, res.statusText);
        return;
      }
      const newText = await res.text();

      // N·∫øu lastText ch∆∞a c√≥ (l·∫ßn ƒë·∫ßu), set v√† return (ch√∫ng ta s·∫Ω load ƒë·∫ßy ƒë·ªß l√∫c kh·ªüi t·∫°o)
      if (lastText === null) {
        lastText = newText;
        return;
      }

      // N·∫øu thay ƒë·ªïi ho√†n to√†n (k·ªÉ c·∫£ t·ª´ email list -> "[]"), th√¨ load v√† render
      if (newText !== lastText) {
        lastText = newText;
        // parse v√† render ngay (tr√°nh g·ªçi loadEmailsNow ƒë·ªÉ gi·∫£m code), nh∆∞ng c√≥ th·ªÉ t√°i s·ª≠ d·ª•ng:
        let data = [];
        try { data = JSON.parse(newText || "[]"); } catch(e) {
          console.error("parse error on updated text:", e);
          return;
        }
        renderEmails(data);
      }
    } catch (e) {
      console.log("Kh√¥ng th·ªÉ ki·ªÉm tra update:", e);
    }
  }

  // Khi trang m·ªü: t·∫£i 1 l·∫ßn ƒë·∫ßy ƒë·ªß
  loadEmailsNow().then(() => {
    // sau l·∫ßn load ban ƒë·∫ßu, b·∫Øt ƒë·∫ßu polling
    setInterval(checkUpdate, pollingInterval);
  });
</script>

</body>
</html>
