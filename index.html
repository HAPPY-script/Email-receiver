<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üì® Email Receiver</title>
<style>
  :root{
    --bg:#0c0115;
    --panel: rgba(90,12,130,0.28);
    --accent:#b892ff;
    --muted:#bfb0ff;
    --text:#f3eaff;
    --danger:#ff5d9e;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#05000a 0%,var(--bg) 100%);font-family:Inter,Arial,Helvetica,sans-serif;color:var(--text)}
  .wrap{max-width:920px;margin:28px auto;padding:22px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;color:var(--accent);font-size:20px}
  .meta{color:var(--muted);font-size:13px}
  #status{margin-top:14px;color:var(--muted);font-size:14px}
  .emails{margin-top:18px}
  .email{
    background:var(--panel);
    border:1px solid rgba(150,60,255,0.18);
    padding:14px;border-radius:12px;margin-bottom:12px;
    box-shadow:0 6px 24px rgba(120,50,220,0.08);
  }
  .row{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .from{font-weight:700;color:#f9ecff}
  .sub{color:var(--muted);font-size:14px;margin-top:6px}
  .date{color:#d8c9ff;font-size:13px}
  .body{margin-top:10px;color:#efe6ff;white-space:pre-wrap;font-size:14px}
  .controls{margin-top:10px;display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  .btn{
    background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--text);cursor:pointer
  }
  .btn.ghost{background:transparent}
  .btn.danger{background:linear-gradient(90deg,var(--danger),#ff2f84);border:none}
  .center{display:flex;justify-content:center}
  .error{color:#ffb3c9;background:rgba(255,50,120,0.05);padding:8px;border-radius:8px;margin-top:10px}
  footer{margin-top:26px;color:var(--muted);font-size:13px;text-align:center}
  @media(max-width:600px){.row{flex-direction:column;align-items:flex-start}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>üì® Email nh·∫≠n t·ª´ Gmail</h1>
      <div class="meta">Hi·ªÉn th·ªã n·ªôi dung t·ª´ <strong>emails.json</strong></div>
    </div>
    <div class="meta">Theme: Aura t√≠m ‚Ä¢ <span id="count">‚Äì</span> email</div>
  </header>

  <div id="status">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</div>
  <div id="error" class="error" style="display:none"></div>

  <div class="emails" id="emails"></div>

  <div class="center">
    <button class="btn" id="reloadBtn">T·∫£i l·∫°i</button>
    <div style="width:12px"></div>
    <button class="btn ghost" id="openJsonBtn">M·ªü emails.json (raw)</button>
  </div>

  <footer>
    L∆∞u √Ω: n·∫øu b·∫°n d√πng ch·ª©c nƒÉng X√ìA, h√£y ch·ªâ d√πng fine-grained token v√† KH√îNG ƒë·ªÉ token trong file public.
  </footer>
</div>

<script>
(function(){
  const statusEl = document.getElementById('status');
  const errEl = document.getElementById('error');
  const emailsEl = document.getElementById('emails');
  const countEl = document.getElementById('count');

  // Build URL for emails.json robustly (works whether index.html is on /repo/ or root)
  const jsonUrl = new URL('emails.json', window.location.href).href;

  // sanitize -> escape html
  function esc(s){
    if(s === null || s === undefined) return '';
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;');
  }

  function showError(msg){
    errEl.style.display = 'block';
    errEl.textContent = msg;
    statusEl.textContent = 'C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu.';
  }

  async function load(){
    errEl.style.display = 'none';
    statusEl.textContent = 'ƒêang t·∫£i emails.json t·ª´: ' + jsonUrl;
    emailsEl.innerHTML = '';
    countEl.textContent = '‚Äì';

    try{
      const res = await fetch(jsonUrl + '?_=' + Date.now(), {cache:'no-store'});
      if(!res.ok){
        showError(`L·ªói t·∫£i file: ${res.status} ${res.statusText}. Ki·ªÉm tra: ${jsonUrl}`);
        return;
      }
      const txt = await res.text();
      let data;
      try{
        data = JSON.parse(txt || '[]');
      }catch(e){
        showError('File emails.json kh√¥ng ph·∫£i JSON h·ª£p l·ªá. H√£y ki·ªÉm tra n·ªôi dung file tr√™n repo.');
        console.error('JSON parse error:', e);
        return;
      }

      if(!Array.isArray(data)){
        showError('emails.json ph·∫£i l√† 1 m·∫£ng JSON (v√≠ d·ª•: []).');
        return;
      }

      statusEl.textContent = `ƒê√£ t·∫£i ${data.length} email.`;
      countEl.textContent = data.length;
      if(data.length === 0){
        emailsEl.innerHTML = '<div class="small">Kh√¥ng c√≥ email ƒë·ªÉ hi·ªÉn th·ªã.</div>';
        return;
      }

      // Render
      data.forEach((e, i) => {
        const from = esc(e.from || '(Kh√¥ng c√≥)');
        const subj = esc(e.subject || '(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)');
        const date = e.date ? new Date(e.date).toLocaleString() : '(Kh√¥ng c√≥ ng√†y)';
        const body = esc(e.body || '');
        const short = body.length > 1000 ? body.slice(0,1000) + '\n\n... (b·ªã r√∫t g·ªçn)' : body;

        const node = document.createElement('div');
        node.className = 'email';
        node.innerHTML = `
          <div class="row">
            <div>
              <div class="from">${from}</div>
              <div class="sub">${subj}</div>
            </div>
            <div class="date">${date}</div>
          </div>
          <div class="body">${short.replaceAll('\\n','<br>')}</div>
        `;
        emailsEl.appendChild(node);
      });

    }catch(err){
      console.error(err);
      showError('L·ªói kh√¥ng x√°c ƒë·ªãnh khi fetch emails.json (xem console).');
    }
  }

  // buttons
  document.getElementById('reloadBtn').addEventListener('click', load);
  document.getElementById('openJsonBtn').addEventListener('click', () => {
    window.open(jsonUrl, '_blank');
  });

  // auto load
  load();
})();
</script>
</body>
</html>
